<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</title>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            margin: 20px;
            background-color: #f7f7f7;
        }

        .toolbar {
            position: sticky;
            top: 0;
            background: white;
            padding: 10px;
            text-align: center;
            z-index: 1000;
            border-bottom: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .toolbar button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .save-btn { background-color: #4CAF50; color: white; }
        .save-btn:hover { background-color: #45A049; }

        .export-btn { background-color: #2196F3; color: white; }
        .export-btn:hover { background-color: #1E88E5; }

        .delete-btn { background-color: #f44336; color: white; }
        .delete-btn:hover { background-color: #e53935; }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 50px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
            font-size: 16px;
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 70px;
            z-index: 999;
        }

        tr.selected {
            background-color: #fff59d;
        }

        td[contenteditable="true"] {
            outline: none;
        }

        .search-bar {
            margin: 15px 0;
            text-align: center;
        }

        .search-bar input {
            padding: 10px;
            width: 50%;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

<div class="toolbar">
    <button class="save-btn" onclick="saveChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    <button class="export-btn" onclick="exportExcel()">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
    <button class="delete-btn" onclick="deleteRow()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
</div>

{% for sheet in sheets_data %}
    <h2>{{ sheet.name }}</h2>

    <div class="search-bar">
        <input type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„..." onkeyup="searchTable(this, {{ loop.index0 }})">
    </div>

    <table id="table-{{ loop.index0 }}">
        <thead>
            <tr>
                {% for header in sheet.headers %}
                <th>{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in sheet.rows %}
            <tr onclick="selectRow(this)">
                {% for cell in row %}
                <td style="background-color: {% if cell.color %}#{{ cell.color }}{% else %}white{% endif %};" contenteditable="true">{{ cell.value }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}

<script>
let selectedRow = null;

function selectRow(row) {
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = row;
    selectedRow.classList.add('selected');
}

function saveChanges() {
    let tables = document.querySelectorAll('table');
    let data = {};
    tables.forEach((table, index) => {
        let sheetName = document.querySelectorAll('h2')[index].innerText;
        let rows = [];
        let headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText);
        rows.push(headers);
        table.querySelectorAll('tbody tr').forEach(tr => {
            let row = Array.from(tr.children).map(td => td.innerText.trim());
            rows.push(row);
        });
        data[sheetName] = rows;
    });
    fetch('/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(response => response.json())
      .then(data => { if (data.status === 'success') alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!'); });
}

function exportExcel() {
    window.location.href = '/export';
}

function deleteRow() {
    if (selectedRow) {
        selectedRow.remove();
        selectedRow = null;
    } else {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡!');
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function searchTable(input, tableIndex) {
    let filter = input.value.toLowerCase();
    let table = document.getElementById('table-' + tableIndex);
    let trs = table.querySelectorAll('tbody tr');
    trs.forEach(tr => {
        let found = false;
        tr.querySelectorAll('td').forEach(td => {
            if (td.innerText.toLowerCase().includes(filter)) {
                found = true;
            }
        });
        tr.style.display = found ? '' : 'none';
    });
}

// Ø¯Ø§Ù„Ø© ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙŠÙ…
function applyCellColor(cell) {
    let value = cell.innerText.trim();

    if (value === "ØªÙ… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†") {
        cell.style.backgroundColor = "#388E3C";
        let nextCell = cell.nextElementSibling;
        if (nextCell) nextCell.style.backgroundColor = "white";
    } else if (value === "ØªÙ…") {
        cell.style.backgroundColor = "#388E3C";
        let nextCell = cell.nextElementSibling;
        if (nextCell) {
            let nextValue = nextCell.innerText.trim();
            if (nextValue === "") {
                nextCell.style.backgroundColor = "#EF6C00"; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
            } else if (/^\d{4}-\d{2}-\d{2}$/.test(nextValue)) {
                let cellDate = new Date(nextValue);
                let today = new Date();
                cellDate.setHours(0,0,0,0);
                today.setHours(0,0,0,0);
                if (cellDate < today) {
                    nextCell.style.backgroundColor = "#388E3C"; // Ø£Ø®Ø¶Ø±
                } else if (cellDate > today) {
                    nextCell.style.backgroundColor = "#FFF176"; // Ø£ØµÙØ±
                }
            } else {
                nextCell.style.backgroundColor = "white";
            }
        }
    } else if (value.includes("%")) {
        let num = parseFloat(value.replace("%", ""));
        if (!isNaN(num)) {
            if (num < 0) {
                cell.style.backgroundColor = "#EF5350"; // Ø£Ø­Ù…Ø± ÙØ§ØªØ­
            } else if (num > 0) {
                cell.style.backgroundColor = "#388E3C"; // Ø£Ø®Ø¶Ø±
            } else {
                cell.style.backgroundColor = "white";
            }
        }
    } else {
        cell.style.backgroundColor = "white";
    }
}

// ØªÙ„ÙˆÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('td').forEach(cell => {
        applyCellColor(cell);
        cell.addEventListener('input', () => applyCellColor(cell));
    });
});
</script>

</body>
</html>
