<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</title>
    <style>
        body { font-family: Arial; background: white; margin: 0; padding: 0; }
        .tabs { display: flex; background-color: #1565c0; overflow-x: auto; }
        .tab { padding: 14px; color: white; cursor: pointer; }
        .tab.active { background-color: #0b3c91; }
        .content { padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size: 18px; }
        th { background-color: #2e7d32; color: white; }
        tr:nth-child(even) { background-color: #f1f8e9; }
        .sheet { display: none; }
        .sheet.active { display: block; }
        .save-button-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #ffffff;
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #ccc;
        }
        .save-button-container button {
            padding: 12px 24px;
            background: linear-gradient(to right, #388e3c, #4caf50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background 0.3s;
        }
        .save-button-container button:hover {
            background: linear-gradient(to right, #2e7d32, #388e3c);
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #2e7d32;
            z-index: 2;
        }
        .add-row-button {
            margin-top: 10px;
            background: #1565c0;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }
        .add-row-button:hover {
            background: #0b3c91;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 18px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
    <audio id="save-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3fda1b5d3e.mp3" preload="auto"></audio>
</head>
<body>

<div class="save-button-container">
    <button onclick="saveChanges()">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</button>
    <button class="add-row-button" onclick="addRow(this)">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ</button>
</div>

<div class="tabs">
    {% for sheet in sheets_data %}
        <div class="tab" onclick="showSheet('{{ loop.index0 }}')">{{ sheet.name }}</div>
    {% endfor %}
</div>

<div class="content">
    {% for sheet in sheets_data %}
        <div class="sheet" id="sheet-{{ loop.index0 }}">
            <h2>{{ sheet.name }}</h2>
            <input type="text" class="search-input" placeholder="üîç ÿßÿ®ÿ≠ÿ´ ŸáŸÜÿß..." oninput="filterTable(this)">
            <table>
                <thead>
                    <tr>
                        {% for head in sheet.headers %}
                            <th>{{ head }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in sheet.rows %}
                        <tr>
                            {% for cell in row %}
                                <td contenteditable="true" style="background-color: #{{ cell.color }}">{{ cell.value }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ</title>
    <style>
        body { font-family: Arial; background: white; margin: 0; padding: 0; }
        .tabs { display: flex; background-color: #1565c0; overflow-x: auto; }
        .tab { padding: 14px; color: white; cursor: pointer; }
        .tab.active { background-color: #0b3c91; }
        .content { padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 8px; border: 1px solid #ccc; text-align: center; font-size: 18px; }
        th { background-color: #2e7d32; color: white; }
        tr:nth-child(even) { background-color: #f1f8e9; }
        .sheet { display: none; }
        .sheet.active { display: block; }
        .save-button-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #ffffff;
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #ccc;
        }
        .save-button-container button {
            padding: 12px 24px;
            background: linear-gradient(to right, #388e3c, #4caf50);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: background 0.3s;
        }
        .save-button-container button:hover {
            background: linear-gradient(to right, #2e7d32, #388e3c);
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #2e7d32;
            z-index: 2;
        }
        .add-row-button {
            margin-top: 10px;
            background: #1565c0;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }
        .add-row-button:hover {
            background: #0b3c91;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 18px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
    <audio id="save-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_3fda1b5d3e.mp3" preload="auto"></audio>
</head>
<body>

<div class="save-button-container">
    <button onclick="saveChanges()">üíæ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™</button>
</div>

<div class="tabs">
    {% for sheet in sheets_data %}
        <div class="tab" onclick="showSheet('{{ loop.index0 }}')">{{ sheet.name }}</div>
    {% endfor %}
</div>

<div class="content">
    {% for sheet in sheets_data %}
        <div class="sheet" id="sheet-{{ loop.index0 }}">
            <h2>{{ sheet.name }}</h2>
            <input type="text" class="search-input" placeholder="üîç ÿßÿ®ÿ≠ÿ´ ŸáŸÜÿß..." oninput="filterTable(this)">
            <table>
                <thead>
                    <tr>
                        {% for head in sheet.headers %}
                            <th>{{ head }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in sheet.rows %}
                        <tr>
                            {% for cell in row %}
                                <td contenteditable="true" style="background-color: #{{ cell.color }}">{{ cell.value }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button class="add-row-button" onclick="addRow(this)">‚ûï ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ</button>
        </div>
    {% endfor %}
</div>

<script>
    let historyStack = [];

    function showSheet(index) {
        const tabs = document.querySelectorAll('.tab');
        const sheets = document.querySelectorAll('.sheet');
        tabs.forEach(t => t.classList.remove('active'));
        sheets.forEach(s => s.classList.remove('active'));
        tabs[index].classList.add('active');
        sheets[index].classList.add('active');
    }
    showSheet(0);

    function saveChanges() {
        const sound = document.getElementById("save-sound");
        const sheets = document.querySelectorAll('.sheet');
        const data = {};

        sheets.forEach(sheet => {
            const sheetName = sheet.querySelector('h2').textContent;
            const table = sheet.querySelector('table');
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row =>
                Array.from(row.cells).map(cell => cell.textContent.trim())
            );
            data[sheetName] = rows;
        });

        fetch('/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if (res.status === 'success') {
                sound.play();
                alert('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
            } else {
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏');
            }
        })
        .catch(err => alert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ'));
    }

    setInterval(saveChanges, 600000); // ŸÉŸÑ 10 ÿØŸÇÿßÿ¶ŸÇ

    document.addEventListener('keydown', function(e) {
        const active = document.activeElement;

        if (active.tagName === 'TD' && active.isContentEditable) {
            const currentCell = active;
            const currentRow = currentCell.parentElement;
            const table = currentRow.parentElement;
            const allRows = Array.from(table.querySelectorAll('tr'));
            const rowIndex = allRows.indexOf(currentRow);
            const cells = Array.from(currentRow.querySelectorAll('td'));
            const cellIndex = cells.indexOf(currentCell);

            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveChanges();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                const lastChange = historyStack.pop();
                if (lastChange) {
                    lastChange.cell.innerText = lastChange.oldValue || '';
                    applyInstantColor(lastChange.cell);
                }
            }

            if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (cellIndex < cells.length - 1) {
                    cells[cellIndex + 1].focus();
                } else if (rowIndex < allRows.length - 1) {
                    const nextRowCells = Array.from(allRows[rowIndex + 1].querySelectorAll('td'));
                    nextRowCells[0].focus();
                }
            }
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (cellIndex > 0) {
                    cells[cellIndex - 1].focus();
                } else if (rowIndex > 0) {
                    const prevRowCells = Array.from(allRows[rowIndex - 1].querySelectorAll('td'));
                    prevRowCells[prevRowCells.length - 1].focus();
                }
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (rowIndex < allRows.length - 1) {
                    const nextRowCells = Array.from(allRows[rowIndex + 1].querySelectorAll('td'));
                    if (nextRowCells[cellIndex]) {
                        nextRowCells[cellIndex].focus();
                    }
                }
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (rowIndex > 0) {
                    const prevRowCells = Array.from(allRows[rowIndex - 1].querySelectorAll('td'));
                    if (prevRowCells[cellIndex]) {
                        prevRowCells[cellIndex].focus();
                    }
                }
            }

            if (e.key === 'Tab') {
                e.preventDefault();
                if (e.shiftKey) {
                    if (cellIndex > 0) {
                        cells[cellIndex - 1].focus();
                    } else if (rowIndex > 0) {
                        const prevRowCells = Array.from(allRows[rowIndex - 1].querySelectorAll('td'));
                        prevRowCells[prevRowCells.length - 1].focus();
                    }
                } else {
                    if (cellIndex < cells.length - 1) {
                        cells[cellIndex + 1].focus();
                    } else if (rowIndex < allRows.length - 1) {
                        const nextRowCells = Array.from(allRows[rowIndex + 1].querySelectorAll('td'));
                        nextRowCells[0].focus();
                    }
                }
            }

            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) {
                    if (rowIndex > 0) {
                        const upperCell = allRows[rowIndex - 1].querySelectorAll('td')[cellIndex];
                        if (upperCell) upperCell.focus();
                    }
                } else {
                    if (rowIndex < allRows.length - 1) {
                        const lowerCell = allRows[rowIndex + 1].querySelectorAll('td')[cellIndex];
                        if (lowerCell) lowerCell.focus();
                    }
                }
            }
        }
    });

    document.addEventListener('input', function(e) {
        if (e.target.tagName === 'TD' && e.target.isContentEditable) {
            historyStack.push({ cell: e.target, oldValue: e.target.getAttribute('data-old') || '' });
            e.target.setAttribute('data-old', e.target.innerText);
            applyInstantColor(e.target);
        }
    });

    function addRow(button) {
        const sheetDiv = button.parentElement;
        const table = sheetDiv.querySelector('table tbody');
        const colCount = sheetDiv.querySelectorAll('thead th').length;
        const newRow = document.createElement('tr');
        for (let i = 0; i < colCount; i++) {
            const newCell = document.createElement('td');
            newCell.contentEditable = true;
            newCell.innerText = '';
            newRow.appendChild(newCell);
        }
        table.appendChild(newRow);
    }

    function applyInstantColor(cell) {
        const value = cell.innerText.trim();
        if (value === 'ŸÖŸÜÿ¨ÿ≤' || value === 'ÿ™ŸÖ') {
            cell.style.backgroundColor = '#c8e6c9';
        } else if (value === 'ŸÖÿ™ŸàŸÇŸÅ' || value === 'ŸÖÿ§ÿ¨ŸÑ') {
            cell.style.backgroundColor = '#ffcdd2';
        } else {
            cell.style.backgroundColor = '#ffffff';
        }
    }

    function filterTable(input) {
        const filter = input.value.toLowerCase();
        const table = input.nextElementSibling;
        const rows = table.querySelectorAll("tbody tr");

        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll("td"));
            const match = cells.some(cell => cell.textContent.toLowerCase().includes(filter));
            row.style.display = match ? "" : "none";
        });
    }
</script>

</body>
</html>

        </div>
    {% endfor %}
</div>

<script>
    let historyStack = [];

    function showSheet(index) {
        const tabs = document.querySelectorAll('.tab');
        const sheets = document.querySelectorAll('.sheet');
        tabs.forEach(t => t.classList.remove('active'));
        sheets.forEach(s => s.classList.remove('active'));
        tabs[index].classList.add('active');
        sheets[index].classList.add('active');
    }
    showSheet(0);

    function saveChanges() {
        const sound = document.getElementById("save-sound");
        const sheets = document.querySelectorAll('.sheet');
        const data = {};

        sheets.forEach(sheet => {
            const sheetName = sheet.querySelector('h2').textContent;
            const table = sheet.querySelector('table');
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row =>
                Array.from(row.cells).map(cell => cell.textContent.trim())
            );
            data[sheetName] = rows;
        });

        fetch('/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => {
            if (res.status === 'success') {
                sound.play();
                alert('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
            } else {
                alert('‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ≠ŸÅÿ∏');
            }
        })
        .catch(err => alert('‚ùå ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ'));
    }

    setInterval(saveChanges, 600000); // ŸÉŸÑ 10 ÿØŸÇÿßÿ¶ŸÇ

    document.addEventListener('keydown', function(e) {
        const active = document.activeElement;

        if (active.tagName === 'TD' && active.isContentEditable) {
            const currentCell = active;
            const currentRow = currentCell.parentElement;
            const table = currentRow.parentElement;
            const allRows = Array.from(table.querySelectorAll('tr'));
            const rowIndex = allRows.indexOf(currentRow);
            const cells = Array.from(currentRow.querySelectorAll('td'));
            const cellIndex = cells.indexOf(currentCell);

            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveChanges();
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                const lastChange = historyStack.pop();
                if (lastChange) {
                    lastChange.cell.innerText = lastChange.oldValue || '';
                    applyInstantColor(lastChange.cell);
                }
            }

            if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (cellIndex < cells.length - 1) {
                    cells[cellIndex + 1].focus();
                } else if (rowIndex < allRows.length - 1) {
                    const nextRowCells = Array.from(allRows[rowIndex + 1].querySelectorAll('td'));
                    nextRowCells[0].focus();
                }
            }
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                if (cellIndex > 0) {
                    cells[cellIndex - 1].focus();
                } else if (rowIndex > 0) {
                    const prevRowCells = Array.from(allRows[rowIndex - 1].querySelectorAll('td'));
                    prevRowCells[prevRowCells.length - 1].focus();
                }
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (rowIndex < allRows.length - 1) {
                    const nextRowCells = Array.from(allRows[rowIndex + 1].querySelectorAll('td'));
                    if (nextRowCells[cellIndex]) {
                        nextRowCells[cellIndex].focus();
                    }
                }
            }
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (rowIndex > 0) {
                    const prevRowCells = Array.from(allRows[rowIndex - 1].querySelectorAll('td'));
                    if (prevRowCells[cellIndex]) {
                        prevRowCells[cellIndex].focus();
                    }
                }
            }

            if (e.key === 'Tab') {
                e.preventDefault();
                if (e.shiftKey) {
                    if (cellIndex > 0) {
                        cells[cellIndex - 1].focus();
                    } else if (rowIndex > 0) {
                        const prevRowCells = Array.from(allRows[rowIndex - 1].querySelectorAll('td'));
                        prevRowCells[prevRowCells.length - 1].focus();
                    }
                } else {
                    if (cellIndex < cells.length - 1) {
                        cells[cellIndex + 1].focus();
                    } else if (rowIndex < allRows.length - 1) {
                        const nextRowCells = Array.from(allRows[rowIndex + 1].querySelectorAll('td'));
                        nextRowCells[0].focus();
                    }
                }
            }

            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) {
                    if (rowIndex > 0) {
                        const upperCell = allRows[rowIndex - 1].querySelectorAll('td')[cellIndex];
                        if (upperCell) upperCell.focus();
                    }
                } else {
                    if (rowIndex < allRows.length - 1) {
                        const lowerCell = allRows[rowIndex + 1].querySelectorAll('td')[cellIndex];
                        if (lowerCell) lowerCell.focus();
                    }
                }
            }
        }
    });

    document.addEventListener('input', function(e) {
        if (e.target.tagName === 'TD' && e.target.isContentEditable) {
            historyStack.push({ cell: e.target, oldValue: e.target.getAttribute('data-old') || '' });
            e.target.setAttribute('data-old', e.target.innerText);
            applyInstantColor(e.target);
        }
    });

    function addRow(button) {
        const sheetDiv = button.parentElement;
        const table = sheetDiv.querySelector('table tbody');
        const colCount = sheetDiv.querySelectorAll('thead th').length;
        const newRow = document.createElement('tr');
        for (let i = 0; i < colCount; i++) {
            const newCell = document.createElement('td');
            newCell.contentEditable = true;
            newCell.innerText = '';
            newRow.appendChild(newCell);
        }
        table.appendChild(newRow);
    }

    function applyInstantColor(cell) {
        const value = cell.innerText.trim();
        if (value === 'ŸÖŸÜÿ¨ÿ≤' || value === 'ÿ™ŸÖ') {
            cell.style.backgroundColor = '#c8e6c9';
        } else if (value === 'ŸÖÿ™ŸàŸÇŸÅ' || value === 'ŸÖÿ§ÿ¨ŸÑ') {
            cell.style.backgroundColor = '#ffcdd2';
        } else {
            cell.style.backgroundColor = '#ffffff';
        }
    }

    function filterTable(input) {
        const filter = input.value.toLowerCase();
        const table = input.nextElementSibling;
        const rows = table.querySelectorAll("tbody tr");

        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll("td"));
            const match = cells.some(cell => cell.textContent.toLowerCase().includes(filter));
            row.style.display = match ? "" : "none";
        });
    }
</script>

</body>
</html>
